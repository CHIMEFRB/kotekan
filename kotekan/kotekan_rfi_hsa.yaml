---
type: config
# Logging level can be one of:
# OFF, ERROR, WARN, INFO, DEBUG, DEBUG2 (case insensitive)
# Note DEBUG and DEBUG2 require a build with (-DCMAKE_BUILD_TYPE=Debug)
log_level: DEBUG
num_elements: 2048
num_local_freq: 1
num_freq: 1024
udp_packet_size: 4928
num_data_sets: 1
samples_per_data_set: 32768
buffer_depth: 8
num_links: 4
block_size: 32
timesamples_per_packet: 2
num_gpu_frames: 128
cpu_affinity: [2,3,4,5,8,9,10,11]
sk_step: 256
rfi_combined: True
rfi_size: 256
frames_per_packet: 4

# Pool
main_pool:
    kotekan_metadata_pool: chimeMetadata
    num_metadata_objects: 10 * buffer_depth

# Buffers
network_buffers:
    num_frames: buffer_depth
    frame_size: samples_per_data_set * num_elements * num_local_freq * num_data_sets
    metadata_pool: main_pool
    network_input_buffer_0:
        kotekan_buffer: standard
    network_input_buffer_1:
        kotekan_buffer: standard
    network_input_buffer_2:
        kotekan_buffer: standard
    network_input_buffer_3:
        kotekan_buffer: standard

#gpu_output_buffers:
#    num_frames: buffer_depth
#    frame_size: 4 * num_data_sets * num_local_freq * ((num_elements * num_elements) + (num_elements * block_size))
#    metadata_pool: main_pool
#    gpu_output_buffer_0:
#        kotekan_buffer: standard
#    gpu_output_buffer_1:
#        kotekan_buffer: standard
#    gpu_output_buffer_2:
#        kotekan_buffer: standard
#    gpu_output_buffer_3:
#        kotekan_buffer: standard


gpu_rfi_output_buffers:
    num_frames: buffer_depth
    frame_size: 4 * num_local_freq * samples_per_data_set / sk_step
    metadata_pool: main_pool
    gpu_rfi_output_buffer_0:
        kotekan_buffer: standard
    gpu_rfi_output_buffer_1:
        kotekan_buffer: standard
    gpu_rfi_output_buffer_2:
        kotekan_buffer: standard
    gpu_rfi_output_buffer_3:
        kotekan_buffer: standard


#file_output_buffers:
#    num_frames: buffer_depth
#    frame_size: 4 * num_data_sets * num_local_freq * ((num_elements * num_elements) + (num_elements * block_size))
#    metadata_pool: main_pool
#    file_output_buffer_0:
#        kotekan_buffer: standard
#    file_output_buffer_1:
#        kotekan_buffer: standard
#    file_output_buffer_2:
#        kotekan_buffer: standard
#    file_output_buffer_3:
#        kotekan_buffer: standard

gen_data:
  type: const
  value: 255
  test_data_gen_0:
    kotekan_process: testDataGen
    network_out_buf: network_input_buffer_0
  test_data_gen_1:
    kotekan_process: testDataGen
    network_out_buf: network_input_buffer_1
  test_data_gen_2:
    kotekan_process: testDataGen
    network_out_buf: network_input_buffer_2
  test_data_gen_3:
    kotekan_process: testDataGen
    network_out_buf: network_input_buffer_3

# Processes
#dpdk:
#    kotekan_process: dpdkWrapper
#    mode: shuffle4
#    num_lcores: 4
#    link_map: [0,1,2,3]
#    network_out_buf_0: network_input_buffer_0
#    network_out_buf_1: network_input_buffer_1
#    network_out_buf_2: network_input_buffer_2
#    network_out_buf_3: network_input_buffer_3


gpu:
    commands:
    - name: hsa_input_data
      kernel: ''
#    - name: hsa_presum_zero
#      kernel: ''
#    - name: hsa_output_data_zero
#      kernel: ''
    - name: hsa_barrier
      kernel: ''
#    - name: hsa_preseed_kernel
#      kernel: "../lib/hsa/kernels/presum.hsaco"
#    - name: hsa_correlator_kernel
#      kernel: "../lib/hsa/kernels/N2.hsaco"
    - name: hsa_rfi_time_sum
      kernel: '../lib/hsa/kernels/rfi_chime_timesum.hsaco'
    - name: hsa_rfi_input_sum
      kernel: '../lib/hsa/kernels/rfi_chime_inputsum.hsaco'
    - name: hsa_rfi_output
      kernel: ''
#    - name: hsa_output_data
#      kernel: ''
    link_map: [0,1,2,3]
    num_gpus: 4
    buffer_depth: 4
    # Internal N^2 kernel parameter, only needed for N2.hsaco
    # Will be moved into the kernel part of the config once the framework
    # is updated to support args in the command section
    n_intg: 16384
    samples_per_second: 390625
    frame_arrival_period: samples_per_data_set / samples_per_second
    device_interface_log_level: warn
    gpu_0:
        kotekan_process: hsaProcess
        gpu_id: 0
        in_buffers:
          network_buf: network_input_buffer_0
        out_buffers:
#          output_buf: gpu_output_buffer_0  
          rfi_output_buf: gpu_rfi_output_buffer_0
    gpu_1:
        kotekan_process: hsaProcess
        gpu_id: 1
        in_buffers:
          network_buf: network_input_buffer_1
        out_buffers:
#          output_buf: gpu_output_buffer_1
          rfi_output_buf: gpu_rfi_output_buffer_1
    gpu_2:
        kotekan_process: hsaProcess
        gpu_id: 2
        in_buffers:
          network_buf: network_input_buffer_2
        out_buffers:
#          output_buf: gpu_output_buffer_2
          rfi_output_buf: gpu_rfi_output_buffer_2
    gpu_3:
        kotekan_process: hsaProcess
        gpu_id: 3
        in_buffers:
          network_buf: network_input_buffer_3
        out_buffers:
#          output_buf: gpu_output_buffer_3
          rfi_output_buf: gpu_rfi_output_buffer_3

rfiBroadcast:
  kotekan_process: rfiBroadcast
  rfi_in: gpu_rfi_output_buffer_0
  destination_port: 41215
  destination_ip: 10.1.13.1
#  destination_ip: 127.0.0.1
  destination_protocol: UDP

rfiBroadcast1:
  kotekan_process: rfiBroadcast
  rfi_in: gpu_rfi_output_buffer_1
  destination_port: 41216
  destination_ip: 10.1.13.1
#  destination_ip: 127.0.0.1
  destination_protocol: UDP

rfiBroadcast2:
  kotekan_process: rfiBroadcast
  rfi_in: gpu_rfi_output_buffer_2
  destination_port: 41217
  destination_ip: 10.1.13.1
#  destination_ip: 127.0.0.1
  destination_protocol: UDP

rfiBroadcast3:
  kotekan_process: rfiBroadcast
  rfi_in: gpu_rfi_output_buffer_3
  destination_port: 41218
  destination_ip: 10.1.13.1
#  destination_ip: 127.0.0.1 
  destination_protocol: UDP

#accumulate:
#    acc_0:
#        kotekan_process: accumulate
#        in_buf: gpu_output_buffer_0
#        out_buf: file_output_buffer_0
#    acc_1:
#        kotekan_process: accumulate
#        in_buf: gpu_output_buffer_1
#        out_buf: file_output_buffer_1
#    acc_2:
#        kotekan_process: accumulate
#        in_buf: gpu_output_buffer_2
#        out_buf: file_output_buffer_2
#    acc_3:
#        kotekan_process: accumulate
#        in_buf: gpu_output_buffer_3
#        out_buf: file_output_buffer_3

#check_data:
#  real: 8388608
#  imag: 0
#  const_data_check_0:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_0
#  const_data_check_1:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_1
#  const_data_check_2:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_2
#  const_data_check_3:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_3

