---
type: config
log_level: 3
udp_packet_size: 4264
udp_header_size: 168 
num_links: 4
freq_array: [4,7,10,16]
timesamples_per_packet: 16
num_elements: 2048
num_local_freq: 1
num_total_freq: 4
samples_per_data_set: 38400
downsample_time: 3
downsample_freq: 8
factor_upchan: 128
factor_upchan_out: 16
num_data_sets: 1
buffer_depth: 3
num_gpu_frames: 1
num_gpus: 4
num_beams: 4
cpu_affinity: [0,1,2,3,4,5,6,7,8,9,10,11]
sizeof_float: 4

# Pool
main_pool:
    kotekan_metadata_pool: chimeMetadata
    num_metadata_objects: 10 * buffer_depth

# Buffers
gpu_input_buffers:
    num_frames: buffer_depth
    frame_size: samples_per_data_set * num_elements * num_local_freq * num_data_sets
    metadata_pool: main_pool
    gpu_input_buffer_0:
        kotekan_buffer: standard
    gpu_input_buffer_1:
        kotekan_buffer: standard
    gpu_input_buffer_2:
        kotekan_buffer: standard
    gpu_input_buffer_3:
        kotekan_buffer: standard

beamform_output_buffesrs:
    num_frames: buffer_depth
    frame_size: sizeof_float * num_data_sets * (samples_per_data_set/downsample_time/downsample_freq/2) * num_elements
    metadata_pool: main_pool
    beamform_output_buffer_0:
        kotekan_buffer: standard
    beamform_output_buffer_1:
        kotekan_buffer: standard
    beamform_output_buffer_2:
        kotekan_buffer: standard
    beamform_output_buffer_3:
        kotekan_buffer: standard

#cpu_output_buffers:
#    num_frames: buffer_depth
#    frame_size: sizeof_float * num_data_sets * (samples_per_data_set/downsample_time/downsample_freq/2) *# num_elements
#    metadata_pool: main_pool
#    cpu_output_buffer_0:
#        kotekan_buffer: standard

frb_output_buffer:
    num_frames: buffer_depth
    frame_size:  sizeof_float * num_data_sets * (samples_per_data_set/downsample_time/downsample_freq/2) * num_elements + udp_header_size*8*256
    metadata_pool: main_pool
    kotekan_buffer: standard 

file_output_buffer:
    num_frames: buffer_depth
    frame_size:  sizeof_float * num_data_sets * (samples_per_data_set/downsample_time/downsample_freq/2) * num_elements + udp_header_size*8*256
    metadata_pool: main_pool
    file_output_buffer_0:
        kotekan_buffer: standard 
    
gpu:
  commands:
  - name: hsa_input_data
    kernel: ''
  - name: hsa_barrier
    kernel: ''
  - name: hsa_beamform_kernel
    kernel: "../lib/hsa/kernels/unpack_shift_beamform.hsaco"
  - name: hsa_beamform_transpose
    kernel: "../lib/hsa/kernels/transpose.hsaco"
  - name: hsa_beamform_upchan
    kernel: "../lib/hsa/kernels/upchannelize.hsaco"
  - name: hsa_beamform_output
    kernel: ''
  link_map: [0,1,2,3]
  num_gpus: 4
  block_size: 32
  buffer_depth: 3
  gpu_0:
    kotekan_process: hsaProcess
    gpu_id: 0
    network_buffer: gpu_input_buffer_0
    output_buffer: beamform_output_buffer_0
  gpu_1:
    kotekan_process: hsaProcess
    gpu_id: 1
    network_buffer: gpu_input_buffer_1
    output_buffer: beamform_output_buffer_1
  gpu_2:
    kotekan_process: hsaProcess
    gpu_id: 2
    network_buffer: gpu_input_buffer_2
    output_buffer: beamform_output_buffer_2
  gpu_3:
    kotekan_process: hsaProcess
    gpu_id: 3
    network_buffer: gpu_input_buffer_3
    output_buffer: beamform_output_buffer_3

gen_data:
  type: const
  value: 153
  test_data_gen_0:
    kotekan_process: testDataGen
    network_out_buf: gpu_input_buffer_0
  test_data_gen_1:
    kotekan_process: testDataGen
    network_out_buf: gpu_input_buffer_1
  test_data_gen_2:
    kotekan_process: testDataGen
    network_out_buf: gpu_input_buffer_2
  test_data_gen_3:
    kotekan_process: testDataGen
    network_out_buf: gpu_input_buffer_3

#cpu_simulate:
#  cpu_data_sim_0:
#    kotekan_process: gpuBeamformSimulate
#    network_in_buf: gpu_input_buffer_0
#    beam_out_buf: cpu_output_buffer_0

#check_data:
#  bf_data_check_0:
#    kotekan_process: testDataCheckFloat
#    first_buf : beamform_output_buffer_0
#    second_buf: cpu_output_buffer_0

postprocess:
  kotekan_process: frbPostProcess
  network_input_buffer_0: beamform_output_buffer_0
  network_input_buffer_1: beamform_output_buffer_1
  network_input_buffer_2: beamform_output_buffer_2
  network_input_buffer_3: beamform_output_buffer_3
  frb_out_buf: frb_output_buffer

#hex_dump:
#  kotekan_process: hexDump
#  buf: frb_output_buffer
#  len: 128
#  offset: 0

#file_out:
#  base_dir: /data/frb/
#  file_ext: dump
#  file_0:
#    kotekan_process: rawFileWrite
#    in_buf: frb_output_buffer
#    file_name: frb_out
