---
type: config
# Logging level can be one of:
# OFF, ERROR, WARN, INFO, DEBUG, DEBUG2 (case insensitive)
# Note DEBUG and DEBUG2 require a build with (-DCMAKE_BUILD_TYPE=Debug)
log_level: debug
num_elements: 2048
num_local_freq: 1
udp_packet_size: 4928
num_data_sets: 1
samples_per_data_set: 32768
buffer_depth: 8
num_links: 4
block_size: 32
timesamples_per_packet: 2
num_gpu_frames: 128
cpu_affinity: [4,5,6,7,8,9,10,11]

# Pool
main_pool:
    kotekan_metadata_pool: chimeMetadata
    num_metadata_objects: 10 * buffer_depth

# Buffers
network_buffers:
    num_frames: buffer_depth
    frame_size: samples_per_data_set * num_elements * num_local_freq * num_data_sets
    metadata_pool: main_pool
    network_input_buffer_0:
        kotekan_buffer: standard
    network_input_buffer_1:
        kotekan_buffer: standard
    network_input_buffer_2:
        kotekan_buffer: standard
    network_input_buffer_3:
        kotekan_buffer: standard

gpu_output_buffers:
    num_frames: buffer_depth
    frame_size: 4 * num_data_sets * num_local_freq * ((num_elements * num_elements) + (num_elements * block_size))
    metadata_pool: main_pool
    gpu_output_buffer_0:
        kotekan_buffer: standard
    gpu_output_buffer_1:
        kotekan_buffer: standard
    gpu_output_buffer_2:
        kotekan_buffer: standard
    gpu_output_buffer_3:
        kotekan_buffer: standard

file_output_buffers:
    num_frames: buffer_depth
    frame_size: 4 * num_data_sets * num_local_freq * ((num_elements * num_elements) + (num_elements * block_size))
    metadata_pool: main_pool
    file_output_buffer_0:
        kotekan_buffer: standard
    file_output_buffer_1:
        kotekan_buffer: standard
    file_output_buffer_2:
        kotekan_buffer: standard
    file_output_buffer_3:
        kotekan_buffer: standard

# Processes
dpdk:
    kotekan_process: dpdkWrapper
    mode: shuffle4
    num_lcores: 4
    link_map: [0,1,2,3]
    network_out_buf_0: network_input_buffer_0
    network_out_buf_1: network_input_buffer_1
    network_out_buf_2: network_input_buffer_2
    network_out_buf_3: network_input_buffer_3

#gen_data:
#  type: const
#  value: 153
#  test_data_gen_0:
#    kotekan_process: testDataGen
#    network_out_buf: network_input_buffer_0
#  test_data_gen_1:
#    kotekan_process: testDataGen
#    network_out_buf: network_input_buffer_1
#  test_data_gen_2:
#    kotekan_process: testDataGen
#    network_out_buf: network_input_buffer_2
#  test_data_gen_3:
#    kotekan_process: testDataGen
#    network_out_buf: network_input_buffer_3

gpu:
    commands:
    - name: hsa_input_data
      kernel: ''
    - name: hsa_presum_zero
      kernel: ''
    - name: hsa_output_data_zero
      kernel: ''
    - name: hsa_barrier
      kernel: ''
    - name: hsa_preseed_kernel
      kernel: "../lib/hsa/kernels/presum.hsaco"
    - name: hsa_correlator_kernel
      kernel: "../lib/hsa/kernels/N2.hsaco"
    - name: hsa_output_data
      kernel: ''
    link_map: [0,1,2,3]
    num_gpus: 4
    buffer_depth: 4
    # Internal N^2 kernel parameter, only needed for N2.hsaco
    # Will be moved into the kernel part of the config once the framework
    # is updated to support args in the command section
    n_intg: 16384
    samples_per_second: 390625
    frame_arrival_period: samples_per_data_set / samples_per_second
    gpu_0:
        kotekan_process: hsaProcess
        gpu_id: 0
        in_buffers:
          network_buf: network_input_buffer_0
        out_buffers:
          output_buf: gpu_output_buffer_0
    gpu_1:
        kotekan_process: hsaProcess
        gpu_id: 1
        in_buffers:
          network_buf: network_input_buffer_1
        out_buffers:
          output_buf: gpu_output_buffer_1
    gpu_2:
        kotekan_process: hsaProcess
        gpu_id: 2
        in_buffers:
          network_buf: network_input_buffer_2
        out_buffers:
          output_buf: gpu_output_buffer_2
    gpu_3:
        kotekan_process: hsaProcess
        gpu_id: 3
        in_buffers:
          network_buf: network_input_buffer_3
        out_buffers:
          output_buf: gpu_output_buffer_3

accumulate:
    acc_0:
        kotekan_process: accumulate
        in_buf: gpu_output_buffer_0
        out_buf: file_output_buffer_0
    acc_1:
        kotekan_process: accumulate
        in_buf: gpu_output_buffer_1
        out_buf: file_output_buffer_1
    acc_2:
        kotekan_process: accumulate
        in_buf: gpu_output_buffer_2
        out_buf: file_output_buffer_2
    acc_3:
        kotekan_process: accumulate
        in_buf: gpu_output_buffer_3
        out_buf: file_output_buffer_3

#python_plot:
#  plot_0:
#    kotekan_process: pyPlotResult
#    in_buf: file_output_buffer_0
#    gpu_id: 0
#  plot_1:
#    kotekan_process: pyPlotResult
#    in_buf: file_output_buffer_1
#    gpu_id: 1
#  plot_2:
#    kotekan_process: pyPlotResult
#    in_buf: file_output_buffer_2
#    gpu_id: 2
#  plot_3:
#    kotekan_process: pyPlotResult
#    in_buf: file_output_buffer_3
#    gpu_id: 3

#file_out:
#  base_dir: /data/metadata_test2/
#  file_ext: dump
#  file_0:
#    kotekan_process: rawFileWrite
#    in_buf: file_output_buffer_0
#    file_name: corr_gpu0
#  file_1:
#    kotekan_process: rawFileWrite
#    in_buf: file_output_buffer_1
#    file_name: corr_gpu1
#  file_2:
#    kotekan_process: rawFileWrite
#    in_buf: file_output_buffer_2
#    file_name: corr_gpu2
#  file_3:
#    kotekan_process: rawFileWrite
#    in_buf: file_output_buffer_3
#    file_name: corr_gpu3

#check_data:
#  real: 8388608
#  imag: 0
#  const_data_check_0:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_0
#  const_data_check_1:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_1
#  const_data_check_2:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_2
#  const_data_check_3:
#    kotekan_process: constDataCheck
#    buf: file_output_buffer_3

metadata_dump_0:
  kotekan_process: chimeMetadataDump
  log_level: ERROR
  buf: file_output_buffer_0
metadata_dump_1:
  kotekan_process: chimeMetadataDump
  log_level: WARN
  buf: file_output_buffer_1
metadata_dump_2:
  kotekan_process: chimeMetadataDump
  log_level: info
  buf: file_output_buffer_2
metadata_dump_3:
  kotekan_process: chimeMetadataDump
  log_level: debug
  buf: file_output_buffer_3